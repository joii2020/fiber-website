---
layout: ../../layouts/DocLayout.astro
title: "A Basic Example: Two Nodes Transfer"
---

## Overview

This guide walks you through setting up and executing a basic token (CKB) transfer between two nodes in the Fiber network. This is a fundamental example that demonstrates the core functionality of the Fiber Channel Network.

## Prerequisites

- Two Fiber Network Nodes (FNN) instances running
- Basic understanding of command line operations
- curl or similar HTTP client for making RPC calls

## Setting Up Your Nodes

### 1. Prepare Fiber Binary

Download the latest release binary from the [Fiber GitHub Releases](https://github.com/nervosnetwork/fiber/releases) page.

If you prefer to build the binary by yourself, you will need to install Rust and Cargo:

```
git clone https://github.com/nervosnetwork/fiber.git
cd fiber
cargo build --release
```

### 2. Create Data Directories

Set up separate directories for each node:

```
# For Node 1
mkdir node1
cp target/release/fnn node1/
cp config/testnet/config.yml node1/

# For Node 2
mkdir node2
cp target/release/fnn node2/
cp config/testnet/config.yml node2/
```

### 3. Configure Node Keys

Each node needs its own private key for signing transactions:

```
# In each node directory
mkdir ckb
# Use ckb-cli to export or generate keys
ckb-cli account export --lock-arg <lock_arg> --extended-privkey-path ./ckb/exported-key
head -n 1 ./ckb/exported-key > ./ckb/key
```

### 4. Configure Ports

Edit the config.yml files to use different ports for each node:

- Node 1: Port 8227
- Node 2: Port 8238

## Step-by-Step Transfer Process

### 1. Start Both Nodes

```
# Start Node 1
cd node1
RUST_LOG=info ./fnn -c config.yml -d .

# Start Node 2 (in a different terminal)
cd node2
RUST_LOG=info ./fnn -c config.yml -d .
```

### 2. Connect the Nodes

Establish a connection between Node 1 and Node 2:

```sh
curl -s -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "id": "42",
    "jsonrpc": "2.0",
    "method": "connect_peer",
    "params": [
      {"address": "/ip4/127.0.0.1/tcp/8238/p2p/QmcFpUnjRvMyqbFBTn94wwF8LZodvPWpK39Wg9pYr2i4TQ"}
    ]
  }' http://localhost:8227
```

### 3. Open a Payment Channel

Create a payment channel from Node 1 to Node 2:

```sh
curl -s -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "id": "42",
    "jsonrpc": "2.0",
    "method": "open_channel",
    "params": [{
      "peer_id": "QmcFpUnjRvMyqbFBTn94wwF8LZodvPWpK39Wg9pYr2i4TQ",
      "funding_amount": "0xba43b7400",
      "commitment_delay_epoch": "0x20001000003"
    }]
  }' http://localhost:8227
```

### 4. Generate an Invoice

Create a payment invoice on Node 2 for 100 CKB:

```sh
curl -s -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "id": "42",
    "jsonrpc": "2.0",
    "method": "new_invoice",
    "params": [{
      "amount": "0x2540be400",
      "currency": "Fibt",
      "description": "test invoice generated by node1",
      "expiry": "0xe10",
      "final_cltv": "0x28",
      "payment_preimage": "0x26b069707aec100fd7153f26abe2bea9e32ed0a6ec1b7e3dcd47aa0e684a1412",
      "hash_algorithm": "sha256"
    }]
  }' http://localhost:8237
```

### 5. Make the Payment

Send payment from Node 1 to Node 2 using the generated invoice:

```sh
curl -s -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "id": "42",
    "jsonrpc": "2.0",
    "method": "send_payment",
    "params": [{
      "invoice": "fibt100000000001p..."  # Use the invoice string from step 4
    }]
  }' http://localhost:8227
```

### 6. Verify the Transfer

Check the channel balance to confirm the transfer:

```sh
curl -s -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "id": "42",
    "jsonrpc": "2.0",
    "method": "list_channels",
    "params": [{
      "peer_id": "QmcFpUnjRvMyqbFBTn94wwF8LZodvPWpK39Wg9pYr2i4TQ"
    }]
  }' http://localhost:8227
```

## Closing the Channel

When you're done with the payment channel, you can close it:

```sh
curl -s -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "id": "42",
    "jsonrpc": "2.0",
    "method": "shutdown_channel",
    "params": [{
      "channel_id": "0xcc0b319e3b1155196a4ffc6c2f71205493befee742f9bdd3ef0e11db4a9bbdac",
      "close_script": {
        "code_hash": "0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8",
        "hash_type": "type",
        "args": "0x4d4ae843f62f05bf1ac601b3dbd43b5b4f9a006a"
      },
      "fee_rate": "0x3FC"
    }]
  }' http://localhost:8227
```

## Important Notes

- Always ensure both nodes are properly synced before attempting transfers
- Keep track of your channel IDs and peer IDs
- Monitor your node logs for any errors or important messages
- Make sure to properly close channels when they're no longer needed 
